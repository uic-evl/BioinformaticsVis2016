<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ProbExplorer</title>
    <!-- Stylesheets-->
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="src/css/main.css">
    <link rel="stylesheet" type="text/css" href="lib/css/d3.slider.css">
    <link rel="stylesheet" type="text/css" href="lib/css/d3-tip.css">

    <!-- Libraries-->
    <script   src="https://code.jquery.com/jquery-2.2.3.min.js"
              integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo="
              crossorigin="anonymous"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.11.2/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/promiz/1.0.6/promiz.min.js"></script>

    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script src="http://colorbrewer2.org/export/colorbrewer.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="lib/js/d3.slider.js"></script>
    <script src="lib/js/d3-tip.js"></script>

</head>
<body onload="start()">

<!-- Source -->
<script src="src/js/main.js"></script>
<script src="src/js/utils.js"></script>

<script src="src/js/visualizations/one_dimension.js"></script>
<script src="src/js/visualizations/two_dimension.js"></script>
<script src="src/js/visualizations/third_dimension.js"></script>

<div class="container-fluid">

    <!--Top Row-->
    <div class="row">

        <div class="col-md-3">
            <!--Second Row - Controls-->
            <div class="row">
                <!--First Column-->
                <div class="col-md-12">
                    <!--Project Title Row-->
                    <div class="row">
                        <div class="col-md-8 col-md-offset-0">
                            <h3 style="visibility: hidden">ProbExplorer</h3>
                            <h4 style="visibility: hidden">Visualizing probability landscape of a stochastic gene regulatory network in state and time space</h4>
                        </div>
                    </div>
                    <!--Time slider Row-->
                    <div class="row top-buffer3">
                        <div class="col-md-8 col-md-offset-3">
                            <h4 style="visibility: hidden">Time Slider</h4>
                        </div>
                    </div>
                    <div class="row top-buffer2">
                        <div class="col-md-10">
                            <div id="timeSlider"></div>
                        </div>
                    </div>

                    <!--Button Column-->
                    <div id="buttons" class="row top-buffer" style="visibility: hidden">
                        <div class="col-md-12">
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="checkbox" name="timeCurves" ><span>Show Time Curves</span>
                                </div>
                                <div class="col-md-6">
                                    <input type="checkbox" name="currentTime" > <span>Show Current Time</span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="checkbox" name="heatmap" > <span>Qual. Heat Map</span>
                                </div>
                                <div class="col-md-6">
                                    <input type="checkbox" name="animation" > <span>Run Animation</span>
                                </div>
                                <!--<div class="col-md-6">-->
                                    <!--<input type="checkbox" name="currentTime" > Show Current Time-->
                                <!--</div>-->
                            </div>
                        </div>
                    </div>

                </div>

            </div>
        </div>

        <!--First Column-->
        <div class="col-md-5">
            <svg id="probability"></svg>
        </div>

        <!--Second Column-->
        <div class="col-md-4">

            <div class="row">
                <div class="col-md-8 col-md-offset-4">
                    <h4 style="visibility: hidden">1D Distribution</h4>
                </div>
            </div>

            <!--First Row - Heatmap-->
            <div class="row">
                <div class="col-md-4">
                    <svg id="distribution1D"></svg>
                </div>
            </div>

            <div class="row">
                <div class="col-md-3 col-md-offset-4">
                    <h4 style="visibility: hidden">1D Peaks</h4>
                </div>
            </div>

            <div class="row">
                <div class="col-md-3">
                    <svg id="peaks1D"></svg>
                </div>
            </div>

        </div>
    </div>
    
    <div class="row">
        <div class="col-md-4">
            <svg id="heatmapAB"></svg>
        </div>
        <div class="col-md-4">
            <svg id="heatmapAC"></svg>
        </div>
        <div class="col-md-4">
            <svg id="heatmapBC"></svg>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4"> 
            <div id="plotyly3dAB" style="width:100%;height:60%"></div>
        </div>
        <div class="col-md-4">
            <div id="plotyly3dAC" style="width:100%;height:60%"></div>
        </div>
        <div class="col-md-4">
            <div id="plotyly3dBC" style="width:100%;height:60%"></div>
        </div>
    </div>
</div>


<script>

    /************************************************************************************/
    function start() {

        Application.outerHeight = Math.max( Application.body.scrollHeight || 0, Application.body.offsetHeight ||0,
            Application.html.clientHeight || 0, Application.html.scrollHeight || 0, Application.html.offsetHeight ||0 );

        // main view
        Application.main_width = (Application.outerWidth - Application.margin*3) * 5 / 6;
        Application.main_height =  (Application.outerHeight - Application.margin) / 2 ;

        var prob_div = d3.select("#probability");

        var oneD_svg = prob_div
                .attr("width",  prob_div.node().parentNode.clientWidth - Application.margin)
                .attr("height", Application.main_height - Application.margin * 3)
                .append('g');

        var heatmapAB_div = d3.select("#heatmapAB");
        var heatmapAC_div = d3.select("#heatmapAC");
        var heatmapBC_div = d3.select("#heatmapBC");

        var twoD_AB_svg = heatmapAB_div
                .attr("width",  heatmapAC_div.node().parentNode.clientWidth - Application.margin)
                .attr("height", Application.main_height - Application.margin * 3)
                .append("g");

        var twoD_AC_svg = heatmapAC_div
                .attr("width",  heatmapAC_div.node().parentNode.clientWidth - Application.margin)
                .attr("height", Application.main_height - Application.margin * 3)
                .append("g");

        var twoD_BC_svg = heatmapBC_div
                .attr("width",  heatmapBC_div.node().parentNode.clientWidth - Application.margin)
                .attr("height", Application.main_height - Application.margin * 3)
                .append("g");

        var controlPanel_width = (Application.main_width- Application.margin*3) / 6;

        /************************************************************************************/
        // 1D projection

        Application.oneDV.initialize(oneD_svg);

        // 2D projection
        var pAB = Application.twoDV();
        var pBC = Application.twoDV();
        var pAC = Application.twoDV();

        /************************************************************************************/
        /************************************************************************************/
        // load multiple files and draw
        queue()
                .defer(d3.csv, "./data/Pa_t0-20.csv")
                .defer(d3.csv, "./data/Pb_t0-20.csv")
                .defer(d3.csv, "./data/Pc_t0-20.csv")
                .defer(d3.csv, "./data/Pab_t0-20.csv")
                .defer(d3.csv, "./data/Pac_t0-20.csv")
                .defer(d3.csv, "./data/Pbc_t0-20.csv")
                .defer(d3.csv, "./data/Pabc_t0-20.csv")
                .defer(d3.csv, "./data/state_space.csv")
                .await(loadAll);

        function loadAll(error, Pa_t20, Pb_t20, Pc_t20, Pab_t20, Pac_t20, Pbc_t20, Pabc_t20, States) {
            if (error) {
                console.log(error);
            }

            /* save the data in the global context to avoid passing it around */
            Application.data["Pa"] = Pa_t20;//_.slice(Pa_t20, 0, Application.TimeStep);
            Application.data["Pb"] = Pb_t20;//_.slice(Pb_t20, 0, Application.TimeStep+1);
            Application.data["Pc"] = Pc_t20;//_.slice(Pc_t20, 0, Application.TimeStep+1);

            /* Get the minimum number of molecules for each axis */
            var minX = Math.min(Application.data["Pa"].length, Application.data["Pb"].length);
            var minY = Math.min(Application.data["Pb"].length, Application.data["Pc"].length);

            /* Map the data into the same size range */
            Application.data["Pab"] =  _.reduce(Pab_t20,
                    function(result, value, key){
                        if( value["ProteinA"] < minX && value["ProteinB"] < minY)
                        {
                            result.push(value);
                        }
                        return result;
                    }, []);

            Application.data["Pac"] = _.reduce(Pac_t20,
                    function(result, value, key){
                        if( value["ProteinA"] < minX && value["ProteinC"] < minY)
                        {
                            result.push(value);
                        }
                        return result;
                    }, []);

            Application.data["Pbc"] = _.reduce(Pbc_t20,
                    function(result, value, key){
                        if( value["ProteinB"] < minX && value["ProteinC"] < minY)
                        {
                            result.push(value);
                        }
                        return result;
                    }, []);

            Application.data["Pabc"] = Pabc_t20;

            pAB.initialize(twoD_AB_svg, 'Pab');
            pBC.initialize(twoD_AC_svg, 'Pac');
            pAC.initialize(twoD_BC_svg, 'Pbc');

            var headerRow_oneD = Object.keys(Pa_t20[0]);  // get keys from the first row
            var headerRow_twoD = Object.keys(Pab_t20[0]);  // get keys from the first row
            var headerRow_threeD = Object.keys(Pabc_t20[0]);

            var xMaxP = [];
            xMaxP[0] = d3.max(Pa_t20, function (d) { return +d[headerRow_oneD[0]]; });
            xMaxP[1] = d3.max(Pb_t20, function (d) { return +d[headerRow_oneD[0]]; });
            xMaxP[2] = d3.max(Pc_t20, function (d) { return +d[headerRow_oneD[0]]; });

            var xMax_oneD = d3.max(xMaxP);
            var yMax_oneD = d3.max([Application.utils.findMax(Pa_t20, headerRow_oneD, 1),
                        Application.utils.findMax(Pc_t20, headerRow_oneD, 1),
                        Application.utils.findMax(Pc_t20, headerRow_oneD, 1)]) + 0.01;

            var probMax2D = d3.max([Application.utils.findMax(Pab_t20, headerRow_twoD, 2),
                        Application.utils.findMax(Pac_t20, headerRow_twoD, 2),
                        Application.utils.findMax(Pbc_t20, headerRow_twoD, 2)]) + 0.01;

            var probMax3D = Application.utils.findMax(Pabc_t20, headerRow_threeD, 3);

            /************************************************************************************/
            // time slider
            var startingTime = 0;
            Application.currentTime = 0;

            var timeX = d3.scale.linear().domain([0, Application.TimeStep-1])
                    .range([0, controlPanel_width - Application.margin*2]).clamp(true);

            function toggleLines(evt)
            {
                console.log("toggleLines");

                var selector = "path:not(.time" + Application.currentTime + ")";

                // only show the line corresponding to the
                // current time step
                if(Application.show_projectionOneD_time)
                {
                    prob_div.selectAll(selector)
                            .style('visibility', 'hidden');
                }
                // reset and show all the lines
                else {
                    prob_div.selectAll('path')
                            .style('visibility', 'visible');
                }
            }

            function brushed(evt, value) {

                Application.currentTime = value;
                Application.oneDV.renderLineGraphs(headerRow_oneD);
                Application.oneDV.renderOneDHeatMaps(headerRow_oneD, probMax3D, xMaxP, xMax_oneD, yMax_oneD);
                Application.oneDV.drawPeaks(xMaxP, probMax3D);

                pAB.update2DHeatMap(Application.currentTime, colorbrewer.Set1["4"]);
                pBC.update2DHeatMap(Application.currentTime, colorbrewer.Set1["4"]);
                pAC.update2DHeatMap(Application.currentTime, colorbrewer.Set1["4"]);

                if(Application.show_projectionOneD_time)
                {
                    prob_div.selectAll('path')
                            .style('visibility', 'visible');

                    toggleLines(evt);
                }
                
                /************* 3D Surface Plots ********************************************/
                var plotlyPab = Application.utils.convert4plotly(Pab_t20, Pa_t20.length, Pb_t20.length, 2);
                var plotlyPac = Application.utils.convert4plotly(Pac_t20, Pa_t20.length, Pc_t20.length, 2);
                var plotlyPbc = Application.utils.convert4plotly(Pbc_t20, Pb_t20.length, Pc_t20.length, 2);
            
                Plotly.newPlot('plotyly3dAB', [plotlyPab]); 
                Plotly.newPlot('plotyly3dAC', [plotlyPac]); 
                Plotly.newPlot('plotyly3dBC', [plotlyPbc]); 
            }

            d3.select('#timeSlider')
                    .call(d3.slider()
                            .axis(d3.svg.axis().ticks(Application.TimeStep))
                            .min(startingTime)
                            .max(Application.TimeStep)
                            .step(1)
                            .on("slideend", brushed));

            // show the labels
            d3.selectAll('h3').style({visibility: 'visible'});
            d3.selectAll('h4').style({visibility: 'visible'});

            var buttons = d3.select("#buttons").style({visibility: 'visible'})
                    .selectAll('input')
                    .on('change', function(evt){

                        if(this.name == 'timeCurves')
                        {
                            // flip the state
                            Application.show_projectionTwoD_time = !Application.show_projectionTwoD_time;

                            pAB.showCurves("Pab");
                            pBC.showCurves("Pac");
                            pAC.showCurves("Pbc");

                        }
                        else if(this.name == 'currentTime')
                        {
                            Application.show_projectionOneD_time = !Application.show_projectionOneD_time;
                            toggleLines(evt);
                        }
                        else if(this.name == "heatmap")
                        {
                            // flip the state of the rendering type
                            Application.show_qualitative = !Application.show_qualitative;

                            pAB.update2DHeatMap(Application.currentTime, colorbrewer.Set1["4"]);
                            pBC.update2DHeatMap(Application.currentTime, colorbrewer.Set1["4"]);
                            pAC.update2DHeatMap(Application.currentTime, colorbrewer.Set1["4"]);
                        }
                        else if(this.name == 'animation')
                        {
                            Application.show_animation = !Application.show_animation;
                        }
                        
                    });
            
            function frame() {
                if (Application.show_animation) {
                    Application.currentTime = (Application.currentTime+1) % Application.TimeStep;
                    
                    pAB.update2DHeatMap(Application.currentTime, colorbrewer.Set1["4"]);
                    pBC.update2DHeatMap(Application.currentTime, colorbrewer.Set1["4"]);
                    pAC.update2DHeatMap(Application.currentTime, colorbrewer.Set1["4"]);
                    
                    var plotlyPab = Application.utils.convert4plotly(Pab_t20, Pa_t20.length, Pb_t20.length, 2);
                    var plotlyPac = Application.utils.convert4plotly(Pac_t20, Pa_t20.length, Pc_t20.length, 2);
                    var plotlyPbc = Application.utils.convert4plotly(Pbc_t20, Pb_t20.length, Pc_t20.length, 2);
            
                    Plotly.newPlot('plotyly3dAB', [plotlyPab]); 
                    Plotly.newPlot('plotyly3dAC', [plotlyPac]); 
                    Plotly.newPlot('plotyly3dBC', [plotlyPbc]); 
                }
            }
            var id = setInterval(frame, 100) // draw every 100ms

            /************* Initial Render ********************************************/
            Application.oneDV.drawAxis(xMax_oneD, yMax_oneD);  // draw X/Y-axis

            Application.oneDV.renderLineGraphs(headerRow_oneD);
            Application.oneDV.renderOneDHeatMaps(headerRow_oneD, probMax3D, xMaxP, xMax_oneD, yMax_oneD);
            Application.oneDV.drawPeaks(xMaxP, probMax3D);

            pAB.draw2DHeatMap("Pab" ,probMax2D, Application.currentTime);
            pBC.draw2DHeatMap("Pac", probMax2D, Application.currentTime);
            pAC.draw2DHeatMap("Pbc", probMax2D, Application.currentTime);

            /************* 3D Surface Plots ********************************************/
            var plotlyPab = Application.utils.convert4plotly(Pab_t20, Pa_t20.length, Pb_t20.length, 2);
            var plotlyPac = Application.utils.convert4plotly(Pac_t20, Pa_t20.length, Pc_t20.length, 2);
            var plotlyPbc = Application.utils.convert4plotly(Pbc_t20, Pb_t20.length, Pc_t20.length, 2);
            
            Plotly.newPlot('plotyly3dAB', [plotlyPab]); 
            Plotly.newPlot('plotyly3dAC', [plotlyPac]); 
            Plotly.newPlot('plotyly3dBC', [plotlyPbc]); 
            
        }  // end - loadAll()
    }
    /************************************************************************************/
</script>


</body>
</html>