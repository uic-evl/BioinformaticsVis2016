<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Test</title>
    <!-- Stylesheets-->
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="src/css/main.css">
    <link rel="stylesheet" type="text/css" href="lib/css/d3.slider.css">
    <link rel="stylesheet" type="text/css" href="lib/css/d3-tip.css">

    <!-- Libraries-->
    <script   src="https://code.jquery.com/jquery-2.2.3.min.js"
              integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo="
              crossorigin="anonymous"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.11.2/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/promiz/1.0.6/promiz.min.js"></script>

    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script src="lib/js/d3.slider.js"></script>
    <script src="lib/js/d3-tip.js"></script>

</head>
<body onload="start()">

<!-- Source -->
<script src="src/js/main.js"></script>
<script src="src/js/utils.js"></script>

<script src="src/js/visualizations/one_dimension.js"></script>
<script src="src/js/visualizations/two_dimension.js"></script>
<script src="src/js/visualizations/third_dimension.js"></script>

<div class="container-fluid">

    <!--Top Row-->
    <div class="row">

        <div class="col-md-3">
            <!--Second Row - Controls-->
            <div class="row top-buffer">
                <!--First Column-->
                <div class="col-md-12">
                    <!--Time slider Row-->
                    <div class="row">
                        <div class="col-md-4 col-md-offset-3">
                            <h4 style="visibility: hidden">Time Slider</h4>
                        </div>
                    </div>
                    <div class="row top-buffer2">
                        <div class="col-md-10">
                            <div id="timeSlider"></div>
                        </div>
                    </div>
                    <!--Button Column-->

                    <div id="buttons" class="row top-buffer" style="visibility: hidden">
                        <div class="col-md-12">
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="checkbox" name="timeCurves" > Show Time Curves
                                </div>
                                <div class="col-md-6">
                                    <input type="checkbox" name="currentTime" > Show Current Time
                                </div>
                            </div>

                        </div>
                    </div>

                </div>

            </div>
        </div>

        <!--First Column-->
        <div class="col-md-5">
            <svg id="probability"></svg>
        </div>

        <!--Second Column-->
        <div class="col-md-4">

            <div class="row">
                <div class="col-md-3 col-md-offset-4">
                    <h4 style="visibility: hidden">1D Distribution</h4>
                </div>
            </div>

            <!--First Row - Heatmap-->
            <div class="row">
                <div class="col-md-4">
                    <svg id="distribution1D"></svg>
                </div>
            </div>

            <div class="row">
                <div class="col-md-3 col-md-offset-4">
                    <h4 style="visibility: hidden">1D Peaks</h4>
                </div>
            </div>

            <div class="row">
                <div class="col-md-3">
                    <svg id="peaks1D"></svg>
                </div>
            </div>

        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <svg id="heatmapAB"></svg>
        </div>
        <div class="col-md-4">
            <svg id="heatmapAC"></svg>
        </div>
        <div class="col-md-4">
            <svg id="heatmapBC"></svg>
        </div>
    </div>

</div>

<script>

    /************************************************************************************/
    function start() {

        Application.outerHeight = Math.max( Application.body.scrollHeight || 0, Application.body.offsetHeight ||0,
            Application.html.clientHeight || 0, Application.html.scrollHeight || 0, Application.html.offsetHeight ||0 );

        // main view
        Application.main_width = (Application.outerWidth - Application.margin*3) * 5 / 6;
        Application.main_height =  (Application.outerHeight - Application.margin) / 2 ;

        var prob_div = d3.select("#probability");

        var oneD_svg = prob_div
                .attr("width",  prob_div.node().parentNode.clientWidth - Application.margin)
                .attr("height", Application.main_height - Application.margin * 3)
                .append('g');

        var heatmapAB_div = d3.select("#heatmapAB");
        var heatmapAC_div = d3.select("#heatmapAC");
        var heatmapBC_div = d3.select("#heatmapBC");

        var twoD_AB_svg = heatmapAB_div
                .attr("width",  heatmapAC_div.node().parentNode.clientWidth - Application.margin)
                .attr("height", Application.main_height - Application.margin * 3)
                .append("g");

        var twoD_AC_svg = heatmapAC_div
                .attr("width",  heatmapAC_div.node().parentNode.clientWidth - Application.margin)
                .attr("height", Application.main_height - Application.margin * 3)
                .append("g");

        var twoD_BC_svg = heatmapBC_div
                .attr("width",  heatmapBC_div.node().parentNode.clientWidth - Application.margin)
                .attr("height", Application.main_height - Application.margin * 3)
                .append("g");

        var controlPanel_width = (Application.main_width- Application.margin*3) / 6;

        /************************************************************************************/
        // 1D projection

        Application.oneDV.initialize(oneD_svg);

        // 2D projection
        var pA = Application.twoDV();
        var pB = Application.twoDV();
        var pC = Application.twoDV();

        /************************************************************************************/
        /************************************************************************************/
        // load multiple files and draw
        queue()
                .defer(d3.csv, "Pa_t0-20.csv")
                .defer(d3.csv, "Pb_t0-20.csv")
                .defer(d3.csv, "Pc_t0-20.csv")
                .defer(d3.csv, "Pab_t0-20.csv")
                .defer(d3.csv, "Pac_t0-20.csv")
                .defer(d3.csv, "Pbc_t0-20.csv")
                .defer(d3.csv, "Pabc_t0-20.csv")
                .defer(d3.csv, "state_space.csv")
                .await(loadAll);

        function loadAll(error, Pa_t20, Pb_t20, Pc_t20, Pab_t20, Pac_t20, Pbc_t20, Pabc_t20, States) {
            if (error) {
                console.log(error);
            }

            /* save the data in the global context to avoid passing it around */
            Application.data["Pa"] = Pa_t20;//_.slice(Pa_t20, 0, Application.TimeStep);
            Application.data["Pb"] = Pb_t20;//_.slice(Pb_t20, 0, Application.TimeStep+1);
            Application.data["Pc"] = Pc_t20;//_.slice(Pc_t20, 0, Application.TimeStep+1);

            /* Get the minimum number of molecules for each axis */
            var minX = Math.min(Application.data["Pa"].length, Application.data["Pb"].length);
            var minY = Math.min(Application.data["Pb"].length, Application.data["Pc"].length);

            /* Map the data into the same size range */
            Application.data["Pab"] =  _.reduce(Pab_t20,
                    function(result, value, key){
                        if( value["ProteinA"] < minX && value["ProteinB"] < minY)
                        {
                            result.push(value);
                        }
                        return result;
                    }, []);

            Application.data["Pac"] = _.reduce(Pac_t20,
                    function(result, value, key){
                        if( value["ProteinA"] < minX && value["ProteinC"] < minY)
                        {
                            result.push(value);
                        }
                        return result;
                    }, []);

            Application.data["Pbc"] = _.reduce(Pbc_t20,
                    function(result, value, key){
                        if( value["ProteinB"] < minX && value["ProteinC"] < minY)
                        {
                            result.push(value);
                        }
                        return result;
                    }, []);

            Application.data["Pabc"] = Pabc_t20;

            pA.initialize(twoD_AB_svg, 'Pab');
            pB.initialize(twoD_AC_svg, 'Pac');
            pC.initialize(twoD_BC_svg, 'Pbc');

            var headerRow_oneD = Object.keys(Pa_t20[0]);  // get keys from the first row
            var headerRow_twoD = Object.keys(Pab_t20[0]);  // get keys from the first row
            var headerRow_threeD = Object.keys(Pabc_t20[0]);

            var xMaxP = [];
            xMaxP[0] = d3.max(Pa_t20, function (d) { return +d[headerRow_oneD[0]]; });
            xMaxP[1] = d3.max(Pb_t20, function (d) { return +d[headerRow_oneD[0]]; });
            xMaxP[2] = d3.max(Pc_t20, function (d) { return +d[headerRow_oneD[0]]; });

            var xMax_oneD = d3.max(xMaxP);
            var yMax_oneD = d3.max([Application.utils.findMax(Pa_t20, headerRow_oneD, 1),
                        Application.utils.findMax(Pc_t20, headerRow_oneD, 1),
                        Application.utils.findMax(Pc_t20, headerRow_oneD, 1)]) + 0.01;

            var probMax2D = d3.max([Application.utils.findMax(Pab_t20, headerRow_twoD, 2),
                        Application.utils.findMax(Pac_t20, headerRow_twoD, 2),
                        Application.utils.findMax(Pbc_t20, headerRow_twoD, 2)]) + 0.01;

            var probMax3D = Application.utils.findMax(Pabc_t20, headerRow_threeD, 3);

            /************************************************************************************/
            // time slider
            var startingTime = 0;
            Application.currentTime = 0;

            var timeX = d3.scale.linear().domain([0, Application.TimeStep-1])
                    .range([0, controlPanel_width - Application.margin*2]).clamp(true);

            function brushed(evt, value) {

                Application.currentTime = value;
                Application.oneDV.renderLineGraphs(headerRow_oneD);
                Application.oneDV.renderOneDHeatMaps(headerRow_oneD, probMax3D, xMaxP, xMax_oneD, yMax_oneD);
                Application.oneDV.drawPeaks(xMaxP, probMax3D);

                pA.update2DHeatMap("Pab" , probMax2D, Application.currentTime);
                pB.update2DHeatMap("Pac" , probMax2D, Application.currentTime);
                pC.update2DHeatMap("Pbc" , probMax2D, Application.currentTime);
            }

            d3.select('#timeSlider')
                    .call(d3.slider()
                            .axis(d3.svg.axis().ticks(Application.TimeStep))
                            .min(startingTime)
                            .max(Application.TimeStep-1)
                            .step(1)
                            .on("slideend", brushed));
            // show the labels
            d3.selectAll('h4').style({visibility: 'visible'});
            var buttons = d3.select("#buttons").style({visibility: 'visible'})
                    .selectAll('input')
                    .on('change', function(evt){

                        if(this.name == 'timeCurves'){

                            // flip the state
                            Application.show_projectionTwoD_time = !Application.show_projectionTwoD_time;

                            pA.showCurves("Pab");
                            pB.showCurves("Pac");
                            pC.showCurves("Pbc");

                        }
                        else if(this.name == 'currentTime')
                        {

                        }


                    });

            /************* Initial Render ********************************************/
            Application.oneDV.drawAxis(xMax_oneD, yMax_oneD);  // draw X/Y-axis

            Application.oneDV.renderLineGraphs(headerRow_oneD);
            Application.oneDV.renderOneDHeatMaps(headerRow_oneD, probMax3D, xMaxP, xMax_oneD, yMax_oneD);
            Application.oneDV.drawPeaks(xMaxP, probMax3D);

            pA.draw2DHeatMap("Pab" ,probMax2D, Application.currentTime);
            pB.draw2DHeatMap("Pac", probMax2D, Application.currentTime);
            pC.draw2DHeatMap("Pbc", probMax2D, Application.currentTime);

        }  // end - loadAll()
    }
    /************************************************************************************/
</script>


</body>
</html>